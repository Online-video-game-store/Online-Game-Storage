<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Products</title>
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/heder.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/left-panel.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/product.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/pagination.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/notification.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/cart-popup.css}">
    <script th:src="@{/pk8000/catalog/static/js/add-to-cart.js}"></script>
    <script th:src="@{/pk8000/catalog/static/js/cart-popup.js}"></script>
</head>

<body>

<div class="header">
    <div class="page-title">–ò–≥—Ä—ã –¥–ª—è –ü–ö8000</div>
    <div class="user-info">
        <div th:if="${isAuthenticated}">
            <span th:text="'–ü—Ä–∏–≤–µ—Ç, ' + ${username} + '!'">–ü—Ä–∏–≤–µ—Ç, –ì–æ—Å—Ç—å!</span>
            <a th:href="@{/logout}" class="logout-button">–í—ã—Ö–æ–¥</a>
        </div>
        <div th:if="${!isAuthenticated}">
            <a th:href="@{/oauth2/authorization/online-store-client-id}" class="login-button">–í—Ö–æ–¥</a>
        </div>

        <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
        <div class="cart">
            <a th:href="@{/cart}" class="cart-link">
                üõí –ö–æ—Ä–∑–∏–Ω–∞
                <span class="cart-count" th:text="${cartItemCount}">0</span>
            </a>
        </div>
    </div>
</div>

<div class="container">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ -->
    <div class="sidebar">
        <div class="categories">
            <div th:each="category : ${categories}"
                 class="category-button"
                 th:classappend="${category.name == currentCategory} ? 'active-category' : ''"
                 th:data-category-id="${category.id}"
                 onclick="redirectToCategory(this)">
                <span th:text="${category.name}"></span>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–æ–≤–∞—Ä–æ–≤ -->
    <main class="content">
        <div class="product-grid">
            <div th:each="product : ${products}" class="product-item">
                <div class="product-title" th:text="${product.name}">Product Name</div>
                <img th:src="'data:image/jpeg;base64,' + ${product.imageBase64}" class="product-image" />
                <div class="product-description" th:text="${product.description}">Product description...</div>
                <div class="product-price" th:text="'$' + ${product.price}">Price</div>
                <div class="product-stock" th:data-stock="${product.stock}" th:text="'In stock: ' + ${product.stock}">Stock</div>
                <form>
                    <input type="hidden" name="productId" th:value="${product.id}" />
                    <div class="quantity-controls">
                        <button type="button" onclick="decreaseQuantity(this)">-</button>
                        <input type="number" name="quantity" value="1" min="1" max="5" class="quantity-input" style="width: 50px; text-align: center;" />
                        <button type="button" onclick="increaseQuantity(this)">+</button>
                    </div>
                    <button type="button" class="buy-button">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                </form>
            </div>
        </div>
    </main>
</div>


<div class="pagination-container">
    <!-- –ö–Ω–æ–ø–∫–∞ "Back" -->
<!--    <div class="back-button-container">-->
<!--        <a href="/pk8000/catalog/index" class="button">–ù–∞–∑–∞–¥</a>-->
<!--    </div>-->

    <!-- –ü–∞–≥–∏–Ω–∞—Ç–æ—Ä. –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫. —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —Ñ–∏–ª—å—Ç—Ä–∞, –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º -->
    <div class="pagination" th:with="startPage=${currentPage > 5 ? currentPage - 5 : 0},
                                     endPage=${totalPages > currentPage + 5 ? currentPage + 5 : totalPages - 1}">
        <ul>
            <!-- –ö–Ω–æ–ø–∫–∞ "Previous" -->
            <li th:if="${currentPage > 0}">
                <form th:action="@{/pk8000/catalog/index}" method="get" style="display: inline;">
                    <input type="hidden" name="elemsOfPage" th:value="${elemsOfPage}">
                    <input type="hidden" name="pageNo" th:value="${currentPage - 1}">
                    <input type="hidden" name="categoryId" th:value="${categoryId}">
                    <button type="submit" class="pagination-button">Previous</button>
                </form>
            </li>

            <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
            <li th:each="i : ${#numbers.sequence(startPage, endPage)}">
                <form th:action="@{/pk8000/catalog/index}" method="get" style="display: inline;">
                    <input type="hidden" name="elemsOfPage" th:value="${elemsOfPage}">
                    <input type="hidden" name="pageNo" th:value="${i}">
                    <input type="hidden" name="categoryId" th:value="${categoryId}">
                    <button type="submit"
                            class="pagination-button"
                            th:classappend="${currentPage == i} ? 'active' : ''"
                            th:text="${i + 1}">
                    </button>
                </form>
            </li>

            <!-- –ö–Ω–æ–ø–∫–∞ "Next" -->
            <li th:if="${currentPage < totalPages - 1}">
                <form th:action="@{/pk8000/catalog/index}" method="get" style="display: inline;">
                    <input type="hidden" name="elemsOfPage" th:value="${elemsOfPage}">
                    <input type="hidden" name="pageNo" th:value="${currentPage + 1}">
                    <input type="hidden" name="categoryId" th:value="${categoryId}">
                    <button type="submit" class="pagination-button">Next</button>
                </form>
            </li>
        </ul>
    </div>
</div>



<script>
    function redirectToCategory(element) {
        const categoryId = element.getAttribute("data-category-id");
        const elemsOfPage = 8;
        const pageNo = 0;

        window.location.href = `/pk8000/catalog/index?categoryId=${categoryId}&elemsOfPage=${elemsOfPage}&pageNo=${pageNo}`;
    }

    function increaseQuantity(button) {
        const quantityInput = button.parentElement.querySelector('.quantity-input');
        const productStock = parseInt(button.closest('.product-item').querySelector('.product-stock').dataset.stock);
        let currentQuantity = parseInt(quantityInput.value);
        if (currentQuantity < productStock) {
            quantityInput.value = currentQuantity + 1;
        }
    }

    function decreaseQuantity(button) {
        const quantityInput = button.parentElement.querySelector('.quantity-input');
        let currentQuantity = parseInt(quantityInput.value);
        if (currentQuantity > 1) {                          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            quantityInput.value = currentQuantity - 1;      // –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        }
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const socket = new WebSocket("ws://localhost:9000/ws/notifications");

        socket.onopen = function () {
            console.log("WebSocket connection established.");
        };

        socket.onmessage = function (event) {
            console.log("Notification received: " + event.data);
            alert("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: " + event.data);
            window.location.reload();
        };

        socket.onerror = function(error) {
            console.error("WebSocket Error: ", error);
        };

        // socket.onclose = function () {
        //     console.log("WebSocket connection closed.");
        // };
        socket.onclose = function(event) {
            console.log("WebSocket connection closed.", event);
            if (event.wasClean) {
                console.log(`Closed cleanly, code=<span class="math-inline">\{event\.code\} reason\=</span>{event.reason}`);
            } else {
                console.error('Connection died');
            }
        };

    });
</script>


<!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –∫–æ—Ä–∑–∏–Ω—ã -->
<div id="cart-popup" class="cart-popup">
    <div class="cart-popup-content">
        <span class="close-button">&times;</span>
        <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>

        <div class="cart-items">
            <!-- –¢–æ–≤–∞—Ä—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JS -->
        </div>

        <div class="cart-total">
            <strong>–ò—Ç–æ–≥–æ:</strong> <span>$0.00</span>
        </div>
        <button class="checkout-button">–û–ø–ª–∞—Ç–∏—Ç—å</button>
    </div>
</div>

</body>
</html>