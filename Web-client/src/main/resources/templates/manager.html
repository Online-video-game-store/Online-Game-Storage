<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Products</title>
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/heder.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/left-panel.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/product.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/pagination.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/manager.css}">
</head>

<body>

<div class="header">
    <div class="page-title">–ò–≥—Ä—ã –¥–ª—è –ü–ö8000</div>
    <div class="user-info">
        <div>
            <span th:text="'–ü—Ä–∏–≤–µ—Ç, ' + ${username} + '!'">–ü—Ä–∏–≤–µ—Ç, –ì–æ—Å—Ç—å!</span>
            <a th:href="@{/logout}" class="logout-button">–í—ã—Ö–æ–¥</a>
        </div>
    </div>
</div>

<div class="container">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ -->
    <div class="sidebar">
        <div class="categories">
            <div th:each="category : ${categories}"
                 class="category-button"
                 th:classappend="${category.name == currentCategory} ? 'active-category' : ''"
                 th:data-category-id="${category.id}"
                 onclick="redirectToCategory(this)">
                <span th:text="${category.name}"></span>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div class="filter">
            <h3>–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</h3>
            <input type="text" th:value="${productName}" id="productName" placeholder="–ò–º—è —Ç–æ–≤–∞—Ä–∞" class="filter-input">
            <input type="number" th:value="${minPrice}" id="minPrice" placeholder="–ú–∏–Ω. —Ü–µ–Ω–∞" min="0" class="filter-input">
            <input type="number" th:value="${maxPrice}" id="maxPrice" placeholder="–ú–∞–∫—Å. —Ü–µ–Ω–∞" min="0" class="filter-input">
            <button onclick="redirectToCategory()" class="filter-button">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–æ–≤–∞—Ä–æ–≤ -->
    <main class="content">
        <table class="product-table">
            <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th style="width: 100px;">–¶–µ–Ω–∞</th>
                <th style="width: 80px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th style="width: 80px;">–í –Ω–∞–ª–∏—á–∏–∏</th>
                <th style="width: 30%;">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th style="width: 180px;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="product : ${products}">
                <td><input type="text" th:name="'name_' + ${product.id}" th:value="${product.name}" id="name_${product.id}" /></td>
                <td><input type="number" th:name="'price_' + ${product.id}" step="0.01" th:value="${product.price}" id="price_${product.id}" style="width: 90px;" /></td>
                <td><input type="number" th:name="'category_' + ${product.id}" th:value="${product.category}" id="category_${product.id}" style="width: 70px;" /></td>
                <td><input type="number" th:name="'stock_' + ${product.id}" th:value="${product.stock}" id="stock_${product.id}" style="width: 70px;" /></td>
                <td><textarea th:name="'description_' + ${product.id}" th:text="${product.description}" id="description_${product.id}" style="width: 100%; height: 60px;"></textarea></td>
                <td>
                    <button type="button" th:onclick="'openImageModal(' + ${product.id} + ')'" class="btn-image-manage">üì∑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                </td>
                <td>
                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ JS -->
                    <button type="button" th:onclick="'saveProduct(' + ${product.id} + ')'" >–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </td>
            </tr>
            </tbody>
        </table>
    </main>
</div>

<div id="imageModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏</h2>
        <div id="imageList"></div>
        <input type="file" id="fileInput" multiple />
        <button onclick="uploadImages()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
</div>


<div class="pagination-container">
    <!-- –ü–∞–≥–∏–Ω–∞—Ç–æ—Ä. –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫. —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —Ñ–∏–ª—å—Ç—Ä–∞, –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º -->
    <div class="pagination" th:with="startPage=${currentPage > 5 ? currentPage - 5 : 0},
                                     endPage=${totalPages > currentPage + 5 ? currentPage + 5 : totalPages - 1}">
        <ul>
            <!-- –ö–Ω–æ–ø–∫–∞ "Previous" -->
            <li th:if="${currentPage > 0}">
                <form th:action="@{/pk8000/catalog/index/setup}" method="get" style="display: inline;">
                    <input type="hidden" name="elemsOfPage" th:value="${elemsOfPage}">
                    <input type="hidden" name="pageNo" th:value="${currentPage - 1}">
                    <input type="hidden" name="categoryId" th:value="${categoryId}">
                    <button type="submit" class="pagination-button">Previous</button>
                </form>
            </li>

            <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
            <li th:each="i : ${#numbers.sequence(startPage, endPage)}">
                <form th:action="@{/pk8000/catalog/index/setup}" method="get" style="display: inline;">
                    <input type="hidden" name="elemsOfPage" th:value="${elemsOfPage}">
                    <input type="hidden" name="pageNo" th:value="${i}">
                    <input type="hidden" name="categoryId" th:value="${categoryId}">
                    <button type="submit"
                            class="pagination-button"
                            th:classappend="${currentPage == i} ? 'active' : ''"
                            th:text="${i + 1}">
                    </button>
                </form>
            </li>

            <!-- –ö–Ω–æ–ø–∫–∞ "Next" -->
            <li th:if="${currentPage < totalPages - 1}">
                <form th:action="@{/pk8000/catalog/index/setup}" method="get" style="display: inline;">
                    <input type="hidden" name="elemsOfPage" th:value="${elemsOfPage}">
                    <input type="hidden" name="pageNo" th:value="${currentPage + 1}">
                    <input type="hidden" name="categoryId" th:value="${categoryId}">
                    <button type="submit" class="pagination-button">Next</button>
                </form>
            </li>
        </ul>
    </div>
</div>



<script>
    function redirectToCategory(element = null) {
        const selectedCategory = element ? element : document.querySelector('.category-button.active-category');
        const categoryId = selectedCategory ? selectedCategory.getAttribute("data-category-id") : '';

        const productName = document.getElementById("productName").value;
        const minPrice = document.getElementById("minPrice").value;
        const maxPrice = document.getElementById("maxPrice").value;
        const elemsOfPage = 8;
        const pageNo = 0;

        const queryParams = new URLSearchParams({
            categoryId,
            elemsOfPage,
            pageNo,
            productName,
            minPrice,
            maxPrice
        });
        window.location.href = `/pk8000/catalog/index/setup?${queryParams.toString()}`;
    }
</script>

<script>
    function openFileDialog(productId) {
        const fileInput = document.getElementById('fileInput_' + productId);
        if (fileInput) {
            fileInput.click();
        } else {
            console.error("File input element not found for product ID", productId);
        }
    }

    function handleFileChange(event, productId) {
        const input = event.target;
        const fileNameSpan = document.getElementById('fileName_' + productId);
        // const hiddenInput = document.getElementById('fileHidden_' + productId);

        if (input.files && input.files.length > 0) {
            const fileName = input.files[0].name;

            if (fileNameSpan) {
                fileNameSpan.innerText = fileName;  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞, –≤–∏–¥–∏–º–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            } else {
                console.error("fileName span not found for product ID", productId);
            }

            // if (hiddenInput) {
            //     hiddenInput.value = fileName;  // –û–±–Ω–æ–≤–ª—è–µ–º hidden –ø–æ–ª–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            // } else {
            //     console.error("Hidden input not found for product ID", productId);
            // }

            console.log(`–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª "${fileName}" –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ ${productId}`);
        } else {
            console.log(`–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ ${productId}`);
        }
    }

    function saveProduct(productId) {
        console.log("–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–¥—É–∫—Ç ID:", productId);

        const formData = new FormData();

        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        const nameInput = document.querySelector(`input[name="name_${productId}"]`);
        const priceInput = document.querySelector(`input[name="price_${productId}"]`);
        const categoryInput = document.querySelector(`input[name="category_${productId}"]`);
        const stockInput = document.querySelector(`input[name="stock_${productId}"]`);
        const descriptionInput = document.querySelector(`textarea[name="description_${productId}"]`);
        const fileInput = document.getElementById(`fileInput_${productId}`);
        const hiddenFileNameInput = document.getElementById(`fileHidden_${productId}`);

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è
        formData.append("productId", productId);
        if (nameInput) formData.append("name", nameInput.value);
        if (priceInput) formData.append("price", priceInput.value);
        if (categoryInput) formData.append("category", categoryInput.value);
        if (stockInput) formData.append("stock", stockInput.value);
        if (descriptionInput) formData.append("description", descriptionInput.value);
        if (hiddenFileNameInput) formData.append("imageFileName", hiddenFileNameInput.value);
        // –ï—Å–ª–∏ –±—ã–ª –≤—ã–±—Ä–∞–Ω —Ñ–∞–π–ª ‚Äî –¥–æ–±–∞–≤–∏–º –µ–≥–æ
        if (fileInput && fileInput.files.length > 0) {
            formData.append("file", fileInput.files[0]);
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch("/pk8000/catalog/api/save", {
            method: "POST",
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    alert("–ü—Ä–æ–¥—É–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
                } else {
                    return response.text().then(text => { throw new Error(text); });
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + error.message);
            });
    }

</script>


<script>
    let currentProductId = null;

    function openImageModal(productId) {
        currentProductId = productId;
        fetch(`/pk8000/catalog/api/product/${productId}`)
            .then(res => res.json())
            .then(images => {
                console.log("images:", images);
                const imageList = document.getElementById("imageList");
                imageList.innerHTML = "";

                images.forEach((imageUrl) => {
                    const fileName = extractFileName(imageUrl);
                    const div = document.createElement("div");
                    div.style.marginBottom = "10px";

                    div.innerHTML = `
                    <img src="${imageUrl}" width="100" style="margin-right: 10px;" />
                    <button onclick="deleteImage('${fileName}')">–£–¥–∞–ª–∏—Ç—å</button>
                `;
                    imageList.appendChild(div);
                });

                document.getElementById("imageModal").style.display = "block";
            })
            .catch(err => {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π");
                console.error(err);
            });
    }

    function closeModal() {
        document.getElementById("imageModal").style.display = "none";
        currentProductId = null;
    }


    function uploadImages() {
        const input = document.getElementById("fileInput");
        const formData = new FormData();
        for (const file of input.files) {
            formData.append("images", file);
        }

        fetch(`/products/${currentProductId}/images`, {
            method: "POST",
            body: formData
        })
            .then(() => openImageModal(currentProductId)) // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            .catch(err => {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π");
                console.error(err);
            });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–∑ URL
    function extractFileName(url) {
        return url.substring(url.lastIndexOf('/') + 1);
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    function deleteImage(fileName) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${fileName}?`)) return;

        fetch(`/pk8000/catalog/api/product/${currentProductId}/image/${encodeURIComponent(fileName)}`, {
            method: "DELETE"
        })
            .then(res => {
                if (res.ok) {
                    openImageModal(currentProductId); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
                }
            })
            .catch(err => {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
                console.error(err);
            });
    }

</script>









</body>
</html>
