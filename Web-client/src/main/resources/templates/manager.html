<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Products</title>
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/heder.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/left-panel.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/product.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/pagination.css}">
    <link rel="stylesheet" th:href="@{/pk8000/catalog/static/css/manager.css}">
</head>

<body>

<div class="header">
    <div class="page-title">–ò–≥—Ä—ã –¥–ª—è –ü–ö8000</div>
    <div class="user-info">
        <div>
            <span th:text="'–ü—Ä–∏–≤–µ—Ç, ' + ${username} + '!'">–ü—Ä–∏–≤–µ—Ç, –ì–æ—Å—Ç—å!</span>
            <a th:href="@{/logout}" class="logout-button">–í—ã—Ö–æ–¥</a>
        </div>
    </div>
</div>

<div class="container">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ -->
    <div class="sidebar">
        <div class="categories">
            <div th:each="category : ${categories}"
                 class="category-button"
                 th:classappend="${category.name == currentCategory} ? 'active-category' : ''"
                 th:data-category-id="${category.id}"
                 onclick="redirectToCategory(this)">
                <span th:text="${category.name}"></span>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div class="filter">
            <h3>–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</h3>
            <input type="text" th:value="${productName}" id="productName" placeholder="–ò–º—è —Ç–æ–≤–∞—Ä–∞" class="filter-input">
            <input type="number" th:value="${minPrice}" id="minPrice" placeholder="–ú–∏–Ω. —Ü–µ–Ω–∞" min="0" class="filter-input">
            <input type="number" th:value="${maxPrice}" id="maxPrice" placeholder="–ú–∞–∫—Å. —Ü–µ–Ω–∞" min="0" class="filter-input">
            <button onclick="redirectToCategory()" class="filter-button">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ç–æ–≤–∞—Ä–æ–≤ -->
    <main class="content">
        <table class="product-table">
            <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th style="width: 100px;">–¶–µ–Ω–∞</th>
                <th style="width: 80px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th style="width: 80px;">–í –Ω–∞–ª–∏—á–∏–∏</th>
                <th style="width: 30%;">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th style="width: 180px;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="product : ${products}">
                <td><input type="text" th:name="'name_' + ${product.id}" th:value="${product.name}" id="name_${product.id}" /></td>
                <td><input type="number" th:name="'price_' + ${product.id}" step="0.01" th:value="${product.price}" id="price_${product.id}" style="width: 90px;" /></td>
                <td><input type="number" th:name="'category_' + ${product.id}" th:value="${product.category}" id="category_${product.id}" style="width: 70px;" /></td>
                <td><input type="number" th:name="'stock_' + ${product.id}" th:value="${product.stock}" id="stock_${product.id}" style="width: 70px;" /></td>
                <td><textarea th:name="'description_' + ${product.id}" th:text="${product.description}" id="description_${product.id}" style="width: 100%; height: 60px;"></textarea></td>
                <td>
                    <button type="button" th:onclick="'openImageModal(' + ${product.id} + ')'" class="btn-image-manage">üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</button>
                </td>
                <td>
                    <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è, –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ JS (–∏–ª–∏ —É–¥–∞–ª—è—Ç—å) -->
                    <button type="button" th:onclick="'saveProduct(' + ${product.id} + ')'" >üíæ</button>
                    <button type="button" th:onclick="'deleteProduct(' + ${product.id} + ')'" >üóëÔ∏è</button>
                </td>
            </tr>
            <!-- —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ -->
            <tr>
                <td><input type="text" id="new_name" /></td>
                <td><input type="number" step="0.01" id="new_price" style="width: 90px;" /></td>
                <td><input type="number" id="new_category" style="width: 70px;" /></td>
                <td><input type="number" id="new_stock" style="width: 70px;" /></td>
                <td><textarea id="new_description" style="width: 100%; height: 60px;"></textarea></td>
                <td>‚Äî</td>
                <td>
                    <button type="button" onclick="addNewProduct()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                </td>
            </tr>
            </tbody>
        </table>
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ -->
<div id="imageModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏</h2>
        <div id="imageList" style="display: flex; flex-wrap: wrap;"></div>
        <input type="file" id="fileInput" class="hidden-file-input" />
    </div>
</div>


<div class="pagination-container">
    <!-- –ü–∞–≥–∏–Ω–∞—Ç–æ—Ä. –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫. —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ —Ñ–∏–ª—å—Ç—Ä–∞, –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º -->
    <div class="pagination" th:with="startPage=${currentPage > 5 ? currentPage - 5 : 0},
                                     endPage=${totalPages > currentPage + 5 ? currentPage + 5 : totalPages - 1}">
        <ul>
            <!-- –ö–Ω–æ–ø–∫–∞ "Previous" -->
            <li th:if="${currentPage > 0}">
                <form th:action="@{/pk8000/catalog/index/setup}" method="get" style="display: inline;">
                    <input type="hidden" name="elemsOfPage" th:value="${elemsOfPage}">
                    <input type="hidden" name="pageNo" th:value="${currentPage - 1}">
                    <input type="hidden" name="categoryId" th:value="${categoryId}">
                    <button type="submit" class="pagination-button">Previous</button>
                </form>
            </li>

            <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
            <li th:each="i : ${#numbers.sequence(startPage, endPage)}">
                <form th:action="@{/pk8000/catalog/index/setup}" method="get" style="display: inline;">
                    <input type="hidden" name="elemsOfPage" th:value="${elemsOfPage}">
                    <input type="hidden" name="pageNo" th:value="${i}">
                    <input type="hidden" name="categoryId" th:value="${categoryId}">
                    <button type="submit"
                            class="pagination-button"
                            th:classappend="${currentPage == i} ? 'active' : ''"
                            th:text="${i + 1}">
                    </button>
                </form>
            </li>

            <!-- –ö–Ω–æ–ø–∫–∞ "Next" -->
            <li th:if="${currentPage < totalPages - 1}">
                <form th:action="@{/pk8000/catalog/index/setup}" method="get" style="display: inline;">
                    <input type="hidden" name="elemsOfPage" th:value="${elemsOfPage}">
                    <input type="hidden" name="pageNo" th:value="${currentPage + 1}">
                    <input type="hidden" name="categoryId" th:value="${categoryId}">
                    <button type="submit" class="pagination-button">Next</button>
                </form>
            </li>
        </ul>
    </div>
</div>



<script>
    function redirectToCategory(element = null) {
        const selectedCategory = element ? element : document.querySelector('.category-button.active-category');
        const categoryId = selectedCategory ? selectedCategory.getAttribute("data-category-id") : '';

        const productName = document.getElementById("productName").value;
        const minPrice = document.getElementById("minPrice").value;
        const maxPrice = document.getElementById("maxPrice").value;
        const elemsOfPage = 8;
        const pageNo = 0;

        const queryParams = new URLSearchParams({
            categoryId,
            elemsOfPage,
            pageNo,
            productName,
            minPrice,
            maxPrice
        });
        window.location.href = `/pk8000/catalog/index/setup?${queryParams.toString()}`;
    }
</script>


<script>
    let currentProductId = null;

    function openImageModal(productId) {
        currentProductId = productId;
        fetch(`/pk8000/catalog/api/product/${productId}`)
            .then(res => res.json())
            .then(images => {
                const imageList = document.getElementById("imageList");
                imageList.innerHTML = "";

                images.forEach(imageUrl => {
                    const fileName = extractFileName(imageUrl);

                    const container = document.createElement("div");
                    container.className = "image-preview";

                    const img = document.createElement("img");
                    img.src = imageUrl;
                    img.alt = fileName;
                    img.title = "–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∑–∞–º–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è";
                    img.onclick = () => {
                        const fileInput = document.getElementById("fileInput");
                        fileInput.dataset.replace = fileName;
                        fileInput.click();
                    };
                    const delBtn = document.createElement("button");
                    delBtn.className = "delete-button";
                    delBtn.innerHTML = "&times;";
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteImage(fileName);
                    };

                    container.appendChild(img);
                    container.appendChild(delBtn);
                    imageList.appendChild(container);
                });

                // –ö–Ω–æ–ø–∫–∞ "–¥–æ–±–∞–≤–∏—Ç—å"
                const addBtn = document.createElement("div");
                addBtn.className = "add-image";
                addBtn.innerHTML = "+";
                addBtn.title = "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ";
                addBtn.onclick = () => {
                    const fileInput = document.getElementById("fileInput");
                    delete fileInput.dataset.replace;
                    fileInput.click();
                };

                imageList.appendChild(addBtn);
                document.getElementById("imageModal").style.display = "block";
            })
            .catch(err => {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π");
                console.error(err);
            });
    }

    function closeModal() {
        document.getElementById("imageModal").style.display = "none";
    }

    document.getElementById("fileInput").addEventListener("change", function () {
        if (!this.files || this.files.length === 0)
            return;
        const file = this.files[0];
        const formData = new FormData();
        formData.append("file", file);

        let url = `/pk8000/catalog/api/product/${currentProductId}/upload`;

        // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∑–∞–º–µ–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
        const replaceName = this.dataset.replace;
        if (replaceName) {
            console.log("replaceName", replaceName);
            url += `?replace=${encodeURIComponent(replaceName)}`;
            console.log("url = " + url);
            delete this.dataset.replace; // –û—á–∏—â–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
        }

        fetch(url, {
            method: "POST",
            body: formData
        }).then(() => {
            this.value = ""; // –°–±—Ä–æ—Å input
            openImageModal(currentProductId); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        }).catch(err => {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
            console.error(err);
        });
    });

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–∑ URL
    function extractFileName(url) {
        return url.substring(url.lastIndexOf('/') + 1);
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    function deleteImage(fileName) {

        fetch(`/pk8000/catalog/api/product/${currentProductId}/image/${encodeURIComponent(fileName)}`, {
            method: "DELETE"
        })
            .then(res => {
                if (res.ok) {
                    openImageModal(currentProductId); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
                }
            })
            .catch(err => {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
                console.error(err);
            });
    }

</script>


<script>

    function saveProduct(productId) {

        const nameInput = document.querySelector(`input[name="name_${productId}"]`);
        const priceInput = document.querySelector(`input[name="price_${productId}"]`);
        const categoryInput = document.querySelector(`input[name="category_${productId}"]`);
        const stockInput = document.querySelector(`input[name="stock_${productId}"]`);
        const descriptionInput = document.querySelector(`textarea[name="description_${productId}"]`);

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—è –∑–∞–ø—Ä–æ—Å–∞
        const formData = new FormData();
        formData.append("productId", productId);
        if (nameInput) formData.append("name", nameInput.value);
        if (priceInput) formData.append("price", priceInput.value);
        if (categoryInput) formData.append("category", categoryInput.value);
        if (stockInput) formData.append("stock", stockInput.value);
        if (descriptionInput) formData.append("description", descriptionInput.value);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch("/pk8000/catalog/api/product/update", {
            method: "POST",
            body: formData
        })
            .then(async response => {
                if (response.ok) {
                    alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω—ã!");
                } else {
                    const contentType = response.headers.get("Content-Type");
                    let errorMessage = `–û—à–∏–±–∫–∞ ${response.status}`;
                    if (contentType && contentType.includes("application/json")) {
                        // —ç—Ç–æ JSON
                        try {
                            const errorJson = await response.json();
                            errorMessage = errorJson.message || JSON.stringify(errorJson);
                        } catch (e) {
                            errorMessage = "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ JSON-–æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.";
                        }
                    } else {
                        // —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
                        try {
                            const text = await response.text();
                            if (text.trim()) errorMessage = text;
                        } catch (e) {
                            errorMessage = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.";
                        }
                    }
                    throw new Error(errorMessage);
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: " + error.message);
            });
    }

</script>

<script>
    function addNewProduct() {
        const name = document.getElementById("new_name").value;
        const price = document.getElementById("new_price").value;
        const category = document.getElementById("new_category").value;
        const stock = document.getElementById("new_stock").value;
        const description = document.getElementById("new_description").value;

        const formData = new FormData();
        formData.append("name", name);
        formData.append("price", price);
        formData.append("category", category);
        formData.append("stock", stock);
        formData.append("description", description);

        fetch("/pk8000/catalog/api/product/create", {
            method: "POST",
            body: formData
        })
            .then(async response => {
                if (response.ok) {
                    alert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!");
                    location.reload();
                } else {
                    const text = await response.text();
                    throw new Error(text);
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: " + error.message);
            });
    }

    function deleteProduct(productId) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?")) return;

        fetch(`/pk8000/catalog/api/product/delete/${productId}`, {
            method: "DELETE"
        })
            .then(async response => {
                if (response.ok) {
                    alert("–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω.");
                    location.reload();
                } else {
                    const text = await response.text();
                    throw new Error(text);
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: " + error.message);
            });
    }
</script>

</body>
</html>
