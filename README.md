## Простой онлайн магазин игрушек.
Это просто попытка расширить свои знания. Мои прошлые "изыскания" были основаны
на своей реализации сервера аутентификации и авторизации с протоколом `OAuth2`, 
и на меж сервисном взаимодействии посредством `Feign`.

Здесь в качестве сервера авторизации используется `Keycloak`. А для обмена данными между 
микросервисами используется `RabbitMQ`. 


### Особенности.
В отличие от классической схемы (где web-клиент работает с микросервисами через `Gateway-шлюз`),
здесь `Gateway` частично выполняет роль web-клиента. А если точнее, то переадресовывает запросы,
связанные с web-контентом, на микросервис `Web-Client`, который теперь стал обычным 
сервером ресурсов.

Это позволило легко закрыть доступ к микросервисам, не предназначенных для
публичного доступа.

Из минусов - классическая аутентификация `OAuth2-клиента` теперь не работает. Во-первых,
сервер ресурсов (`Web-Client`) просто не умеет проводить аутентификацию, а во вторых,
её бы, итак, заблокировал `Gateway`. Пришлось найти обходные пути, создав пару эндпоинтов
для этого и выполняя запросы на аутентификацию вручную. То есть самому делать то,
что по сути автоматически выполнял `OAuth2-клиент`.

Еще из неудобств - инклюды в шаблонах `Thymeleaf` не работают, поскольку пути 
перестали быть просто относительными (они ведь проходят через шлюз и `Eureka`). Пришлось учитывать
это в шаблонах.

Так же теперь в `Java Script` нет доступа к аутентификационным данным пользователя, их
банально не пропускает `Gateway`. С одной стороны неплохо, с другой - приходится
учитывать это при создании `UI`.

Всё это было решено и прекрасно работает.


## Подготовка к работе.
Вначале [устанавливаем и настраиваем контейнер с программами Keycloak, MySQL и RabbitMQ](Docker.md)


## Переменные окружения.
Для развертывания в продакшн необходимо установить переменную среды окружения:
`OAUTH2_BASE_ISSUER_URI=<адрес сервера Keycloak>:порт`

Также необходимо задать пути для пользовательской авторизации:

`OAUTH2_BASE_AUTH_URI=<базовый адрес клиента>:порт`

Для Эврики:

`EUREKA_SERVER_URL=<адрес сервера Eureka>/eureka`

***Например***:
```
OAUTH2_BASE_ISSUER_URI=http://192.168.1.179:8080
OAUTH2_BASE_AUTH_URI=http://192.168.1.179:9000
EUREKA_SERVER_URL=http://192.168.1.179:7777/eureka
```


## Spring Cloud Bus + RabbitMQ (с Management Plugin)

Порт 5672 — стандартный порт для AMQP-протокола.

Порт 15672 — для веб-интерфейса RabbitMQ Management.

Админка соответственно: http://localhost:15672

Пароль и логин (задается в `.env.rabbitmq`): `admin`


## MySql
Настройки задаются в .env.mysql. 
Для ручного администрирования можно зайти под `root` в контейнере:
```shell
mysql -uroot -padmin
```


## Микросервисы.
### Catalog-service.
Базовый путь к изображениям задан в переменной app.images-path. Окончательный путь формируется как:
{app.images-path}/{productId}/{filename.pic}
где: productId - уникальный ID товара.
При удалении товара удаляется весь подкаталог с содержимым.

